using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Numerics;
using System.Threading;
using System.Threading.Tasks;

using Nethereum.Geth;
using Nethereum.Web3;
using Nethereum.Web3.Accounts;
using Nethereum.Web3.Accounts.Managed;
using Nethereum.Contracts;
using Nethereum.Hex.HexTypes;
using Nethereum.Hex.HexConvertors.Extensions;
using Nethereum.RPC.Eth;
using Nethereum.RPC.Eth.DTOs;
using Nethereum.RPC.Eth.Filters;
using Nethereum.ABI.FunctionEncoding.Attributes;

using Nethereum.ABI.FunctionEncoding;
using Nethereum.ABI.Model;
using Nethereum.JsonRpc.Client;

using Nethereum.ABI.Encoders;

using FDBC_Nethereum.DotNetWeb3Geth;
using Newtonsoft.Json;

namespace FDBC_Nethereum.SmartContracts
{
  public class Flight
  {
    private readonly Web3Geth _web3geth;
    private readonly string _default_sender_address;
    private readonly string _default_sender_password;
    private readonly string _test_existing_contract_address;
    private readonly string _contract_abi;
    private readonly string _contract_bytecode;

    public Flight(Web3Geth web3geth)
    {
      _web3geth = web3geth;
      _default_sender_address = "0x6376612e86c6f0be774cfa62e0eb732f87352115";
      _default_sender_password = "123";
      //_default_sender_address = "0x1b8fcde4948de04ab9d67600a145886a3544dfaa";
      //_default_sender_password = "dev_password";

      _contract_abi = @"[{'constant':true,'inputs':[],'name':'ufid','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'actual_departure_date_time','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'hash','outputs':[{'name':'','type':'bytes32'}],'payable':false,'type':'function'},{'constant':false,'inputs':[],'name':'PostInit','outputs':[],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_deleted','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'arrival_utc_offset_hours','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_cancel_date_time','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'status','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'delay_notification_date_time','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_status','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'departure_airport','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'departure_utc_offset_hours','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_cancel_date_time_local','outputs':[],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_delay_notification_date_time','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'cancel_date_time','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'scheduled_departure_date','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'actual_departure_date_time_local','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_actual_departure_date_time','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'flight_status_fed','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'deleted','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_flight_status_fed','outputs':[],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_actual_arrival_date_time_local','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'arrival_airport','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'scheduled_departure_date_time','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_actual_departure_date_time_local','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'scheduled_arrival_date_time_local','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'scheduled_arrival_date_time','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'flight_code','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_actual_arrival_date_time','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'scheduled_departure_date_time_local','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'cancel_date_time_local','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':false,'inputs':[{'name':'task_uuid','type':'string'},{'name':'input','type':'string'}],'name':'set_flight_status_source','outputs':[],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'flight_id','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'fs_flight_code','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'actual_arrival_date_time','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'flight_status_source','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'pid','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'constant':true,'inputs':[],'name':'actual_arrival_date_time_local','outputs':[{'name':'','type':'string'}],'payable':false,'type':'function'},{'inputs':[{'name':'task_uuid','type':'string'},{'name':'_flight_id','type':'string'},{'name':'_pid','type':'string'},{'name':'_ufid','type':'string'},{'name':'_flight_code','type':'string'},{'name':'_fs_flight_code','type':'string'},{'name':'_departure_utc_offset_hours','type':'string'},{'name':'_arrival_utc_offset_hours','type':'string'},{'name':'_departure_airport','type':'string'},{'name':'_arrival_airport','type':'string'},{'name':'_scheduled_departure_date','type':'string'},{'name':'_scheduled_departure_date_time','type':'string'},{'name':'_scheduled_departure_date_time_local','type':'string'},{'name':'_scheduled_arrival_date_time','type':'string'},{'name':'_scheduled_arrival_date_time_local','type':'string'}],'payable':false,'type':'constructor'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'flight_contract_address','type':'address'}],'name':'event_new_flight','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_status','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_actual_departure_date_time','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_actual_departure_date_time_local','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_actual_arrival_date_time','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_actual_arrival_date_time_local','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_cancel_date_time','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_cancel_date_time_local','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_deleted','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_flight_status_source','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_flight_status_fed','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'name':'task_uuid','type':'bytes32'},{'indexed':false,'name':'old_val','type':'string'},{'indexed':false,'name':'new_val','type':'string'}],'name':'event_set_delay_notification_date_time','type':'event'}]";
      _contract_bytecode = "606060405234156200001057600080fd5b60405162003f0038038062003f008339810160405280805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805182019190602001805190910190505b60008e8051620000c1929160200190620004d4565b5060018d8051620000d7929160200190620004d4565b5060028c8051620000ed929160200190620004d4565b5060038b805162000103929160200190620004d4565b5060048a805162000119929160200190620004d4565b5060058980516200012f929160200190620004d4565b50600688805162000145929160200190620004d4565b5060078780516200015b929160200190620004d4565b50600886805162000171929160200190620004d4565b50600a85805162000187929160200190620004d4565b50600b8480516200019d929160200190620004d4565b50600c838051620001b3929160200190620004d4565b50600f828051620001c9929160200190620004d4565b506010818051620001df929160200190620004d4565b50620001f864010000000062001750620002ab82021704565b8e6040518082805190602001908083835b602083106200022b57805182525b601f19909201916020918201910162000209565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f49dfab8134d508afbfbed5727f26e09e32ef4e1cf65ebafea6f4e83808d2606530604051600160a060020a03909116815260200160405180910390a25b5050505050505050505050505050506200057e565b6003600a600760086040518085805460018160011615610100020316600290048015620003125780601f10620002ef57610100808354040283529182019162000312565b820191906000526020600020905b815481529060010190602001808311620002fd575b5050848054600181600116156101000203166002900480156200036f5780601f106200034c5761010080835404028352918201916200036f565b820191906000526020600020905b8154815290600101906020018083116200035a575b505083805460018160011615610100020316600290048015620003cc5780601f10620003a9576101008083540402835291820191620003cc565b820191906000526020600020905b815481529060010190602001808311620003b7575b505082805460018160011615610100020316600290048015620004295780601f106200040657610100808354040283529182019162000429565b820191906000526020600020905b81548152906001019060200180831162000414575b505094505050505060405190819003902060155560408051908101604052600581527f66616c73650000000000000000000000000000000000000000000000000000006020820152601690805162000486929160200190620004d4565b5060408051908101604052600581527f66616c736500000000000000000000000000000000000000000000000000000060208201526018908051620004d0929160200190620004d4565b505b565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200051757805160ff191683800117855562000547565b8280016001018555821562000547579182015b82811115620005475782518255916020019190600101906200052a565b5b50620005569291506200055a565b5090565b6200057b91905b8082111562000556576000815560010162000561565b5090565b90565b613972806200058e6000396000f300606060405236156101d55763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416630424c10481146101da5780630723f6231461026557806309bd5a60146102f05780630a2e48f6146103155780631199fd881461032a57806313faec70146103bf57806318c7688f1461044a578063200d2ed2146104df57806326fb6d4e1461056a57806329c3c295146105f55780632fbf19621461068a5780633ff41fce14610715578063457b697c146107a057806346560b8d14610835578063486369dc146108ca5780634aca2dbf146109555780634be3a1ad146109e05780634c61f3a114610a6b5780635a7211ad14610b005780636b35f7c114610b8b5780637117ff6c14610c16578063782076c514610cab57806391cc47f014610d4057806392d93c5f14610dcb57806394fc4dc514610e56578063964a2d5c14610eeb578063a6cd87ee14610f76578063af63770814611001578063af6c29431461108c578063b04db85614611121578063b0b46ebb146111ac578063b0cf1f0714611237578063b5884e26146112cc578063bedd1ffc14611357578063c0d823cd146113e2578063cfe792fe1461146d578063f1068454146114f8578063fa6d047814611583575b600080fd5b34156101e557600080fd5b6101ed61160e565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561027057600080fd5b6101ed6116ac565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156102fb57600080fd5b61030361174a565b60405190815260200160405180910390f35b341561032057600080fd5b610328611750565b005b341561033557600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061196595505050505050565b005b34156103ca57600080fd5b6101ed611af2565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561045557600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650611b9095505050505050565b005b34156104ea57600080fd5b6101ed611d1d565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561057557600080fd5b6101ed611dbb565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561060057600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650611e5995505050505050565b005b341561069557600080fd5b6101ed611fe6565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561072057600080fd5b6101ed612084565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156107ab57600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061212295505050505050565b005b341561084057600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405281815292919060208401838380828437509496506122af95505050505050565b005b34156108d557600080fd5b6101ed61243c565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561096057600080fd5b6101ed6124da565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156109eb57600080fd5b6101ed612578565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3415610a7657600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061261695505050505050565b005b3415610b0b57600080fd5b6101ed6127a3565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3415610b9657600080fd5b6101ed612841565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3415610c2157600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405281815292919060208401838380828437509496506128df95505050505050565b005b3415610cb657600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650612a6c95505050505050565b005b3415610d4b57600080fd5b6101ed612bf9565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3415610dd657600080fd5b6101ed612c97565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3415610e6157600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650612d3595505050505050565b005b3415610ef657600080fd5b6101ed612ec2565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3415610f8157600080fd5b6101ed612f60565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561100c57600080fd5b6101ed612ffe565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561109757600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061309c95505050505050565b005b341561112c57600080fd5b6101ed613229565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156111b757600080fd5b6101ed6132c7565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561124257600080fd5b61032860046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061336595505050505050565b005b34156112d757600080fd5b6101ed6134f2565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561136257600080fd5b6101ed613590565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156113ed57600080fd5b6101ed61362e565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561147857600080fd5b6101ed6136cc565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561150357600080fd5b6101ed61376a565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561158e57600080fd5b6101ed613808565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561022a5780820151818401525b602001610211565b50505050905090810190601f1680156102575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b60028054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b600d8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60155481565b6003600a6007600860405180858054600181600116156101000203166002900480156117b35780601f106117915761010080835404028352918201916117b3565b820191906000526020600020905b81548152906001019060200180831161179f575b50508480546001816001161561010002031660029004801561180c5780601f106117ea57610100808354040283529182019161180c565b820191906000526020600020905b8154815290600101906020018083116117f8575b5050838054600181600116156101000203166002900480156118655780601f10611843576101008083540402835291820191611865565b820191906000526020600020905b815481529060010190602001808311611851575b5050828054600181600116156101000203166002900480156118be5780601f1061189c5761010080835404028352918201916118be565b820191906000526020600020905b8154815290600101906020018083116118aa575b505094505050505060405190819003902060155560408051908101604052600581527f66616c7365000000000000000000000000000000000000000000000000000000602082015260169080516119199291602001906138a6565b5060408051908101604052600581527f66616c7365000000000000000000000000000000000000000000000000000000602082015260189080516119619291602001906138a6565b505b565b816040518082805190602001908083835b6020831061199657805182525b601f199092019160209182019101611976565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f7869ee11cc6ef6d36afa40dbb9213081f014daa6b79e7af8fd10f0ee632301c7601683604051604080825283546002600019610100600184161502019091160490820181905281906020820190606083019086908015611a655780601f10611a3a57610100808354040283529160200191611a65565b820191906000526020600020905b815481529060010190602001808311611a4857829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b83811015611a9d5780820151818401525b602001611a84565b50505050905090810190601f168015611aca5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26016818051611aec9291602001906138a6565b505b5050565b60068054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b60208310611bc157805182525b601f199092019160209182019101611ba1565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f99bc47e17aea8382cddcc3caeff1aca2ce9ca24397fc2832f4a1080990b38c46601383604051604080825283546002600019610100600184161502019091160490820181905281906020820190606083019086908015611c905780601f10611c6557610100808354040283529160200191611c90565b820191906000526020600020905b815481529060010190602001808311611c7357829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b83811015611cc85780820151818401525b602001611caf565b50505050905090810190601f168015611cf55780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26013818051611aec9291602001906138a6565b505b5050565b60098054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60198054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b60208310611e8a57805182525b601f199092019160209182019101611e6a565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f775048f6e5511b48bdba9d7167a14398988fb5f1174516da0fea78bb16a7cc60600983604051604080825283546002600019610100600184161502019091160490820181905281906020820190606083019086908015611f595780601f10611f2e57610100808354040283529160200191611f59565b820191906000526020600020905b815481529060010190602001808311611f3c57829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b83811015611f915780820151818401525b602001611f78565b50505050905090810190601f168015611fbe5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26009818051611aec9291602001906138a6565b505b5050565b60078054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60058054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b6020831061215357805182525b601f199092019160209182019101612133565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207fc6abcd253dd3ed78f6a5f56536d662b009f976d22f558237218afd93c03d5d306014836040516040808252835460026000196101006001841615020190911604908201819052819060208201906060830190869080156122225780601f106121f757610100808354040283529160200191612222565b820191906000526020600020905b81548152906001019060200180831161220557829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b8381101561225a5780820151818401525b602001612241565b50505050905090810190601f1680156122875780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26014818051611aec9291602001906138a6565b505b5050565b816040518082805190602001908083835b602083106122e057805182525b601f1990920191602091820191016122c0565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f938a75161a4516a2cc8719fd7c452b311a66131eba9a742343ae58fc7ef394936019836040516040808252835460026000196101006001841615020190911604908201819052819060208201906060830190869080156123af5780601f10612384576101008083540402835291602001916123af565b820191906000526020600020905b81548152906001019060200180831161239257829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b838110156123e75780820151818401525b6020016123ce565b50505050905090810190601f1680156124145780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26019818051611aec9291602001906138a6565b505b5050565b60138054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b600a8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b600e8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b6020831061264757805182525b601f199092019160209182019101612627565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207fbdef44ac46879f9c70461804c592244c2e78bf09247bb7a27ae00fe7d08cc6ed600d836040516040808252835460026000196101006001841615020190911604908201819052819060208201906060830190869080156127165780601f106126eb57610100808354040283529160200191612716565b820191906000526020600020905b8154815290600101906020018083116126f957829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b8381101561274e5780820151818401525b602001612735565b50505050905090810190601f16801561277b5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a2600d818051611aec9291602001906138a6565b505b5050565b60188054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60168054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b6020831061291057805182525b601f1990920191602091820191016128f0565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f8448c79207f1c74f7dc14b6a82cfd9d4f5fda5e9b504e8d2449a446b77b614426018836040516040808252835460026000196101006001841615020190911604908201819052819060208201906060830190869080156129df5780601f106129b4576101008083540402835291602001916129df565b820191906000526020600020905b8154815290600101906020018083116129c257829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b83811015612a175780820151818401525b6020016129fe565b50505050905090810190601f168015612a445780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26018818051611aec9291602001906138a6565b505b5050565b816040518082805190602001908083835b60208310612a9d57805182525b601f199092019160209182019101612a7d565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207fed4210749f81cc94d525cd4ad4494df18d4c3112ad482fd19f48e755fd8d75a3601283604051604080825283546002600019610100600184161502019091160490820181905281906020820190606083019086908015612b6c5780601f10612b4157610100808354040283529160200191612b6c565b820191906000526020600020905b815481529060010190602001808311612b4f57829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b83811015612ba45780820151818401525b602001612b8b565b50505050905090810190601f168015612bd15780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26012818051611aec9291602001906138a6565b505b5050565b60088054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b600b8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b60208310612d6657805182525b601f199092019160209182019101612d46565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f8c8724fbc2fa465363c1f9e9899fa3add0491d7b0fa7598cd59b8dcbfd8f1877600e83604051604080825283546002600019610100600184161502019091160490820181905281906020820190606083019086908015612e355780601f10612e0a57610100808354040283529160200191612e35565b820191906000526020600020905b815481529060010190602001808311612e1857829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b83811015612e6d5780820151818401525b602001612e54565b50505050905090810190601f168015612e9a5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a2600e818051611aec9291602001906138a6565b505b5050565b60108054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b600f8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60038054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b602083106130cd57805182525b601f1990920191602091820191016130ad565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f49850e312ca7ba9c18d6f314f03d79ac3e8758f406ff1a82820ebee4431764d760118360405160408082528354600260001961010060018416150201909116049082018190528190602082019060608301908690801561319c5780601f106131715761010080835404028352916020019161319c565b820191906000526020600020905b81548152906001019060200180831161317f57829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b838110156131d45780820151818401525b6020016131bb565b50505050905090810190601f1680156132015780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26011818051611aec9291602001906138a6565b505b5050565b600c8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60148054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b816040518082805190602001908083835b6020831061339657805182525b601f199092019160209182019101613376565b6001836020036101000a03801982511681845116179092525050509190910192506040915050519081900390207f11efc5770e7eb66c1dac2016e3e98464a7ed9ac728f18184cf9626aaa22dc21c6017836040516040808252835460026000196101006001841615020190911604908201819052819060208201906060830190869080156134655780601f1061343a57610100808354040283529160200191613465565b820191906000526020600020905b81548152906001019060200180831161344857829003601f168201915b5050838103825284818151815260200191508051906020019080838360005b8381101561349d5780820151818401525b602001613484565b50505050905090810190601f1680156134ca5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a26017818051611aec9291602001906138a6565b505b5050565b60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60048054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60118054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60178054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b60128054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116a45780601f10611679576101008083540402835291602001916116a4565b820191906000526020600020905b81548152906001019060200180831161168757829003601f168201915b505050505081565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106138e757805160ff1916838001178555613914565b82800160010185558215613914579182015b828111156139145782518255916020019190600101906138f9565b5b50613921929150613925565b5090565b61394391905b80821115613921576000815560010161392b565b5090565b905600a165627a7a72305820ca3f8bc59aadbe1db41982ab9118d05f5e6ec312f1f8fe0ada90dda3db6b12a20029";
    }

    public async Task<string> Create(
      string task_uuid,
      string flight_id, string pid, string ufid, 
      string flight_code, string fs_flight_code,
      string departure_utc_offset_hours, string arrival_utc_offset_hours,
      string departure_airport, string arrival_airport, 
      string scheduled_departure_date,
      string scheduled_departure_date_time, string scheduled_departure_date_time_local,
      string scheduled_arrival_date_time, string scheduled_arrival_date_time_local)
    {
      Web3Geth web3geth = _web3geth;
      string sender_address = _default_sender_address;
      string sender_password = _default_sender_password;
      string contract_abi = _contract_abi;
      string contract_bytecode = _contract_bytecode;

      ////====================================
      //// deploy contract

      // unlock for 120 secs

      //bool bool_result = await web3geth.Miner.Start.SendRequestAsync(120);

      string tx_hash = await web3geth.Eth.DeployContract.SendRequestAsync(
        abi: contract_abi, 
        contractByteCode: contract_bytecode, 
        from: sender_address, 
        gas: new HexBigInteger(4700000), 
        values: new object[] {
          task_uuid,
          flight_id,
          pid,
          ufid,
          flight_code,
          fs_flight_code,
          departure_utc_offset_hours ,
          arrival_utc_offset_hours,
          departure_airport,
          arrival_airport,
          scheduled_departure_date,
          scheduled_departure_date_time,
          scheduled_departure_date_time_local,
          scheduled_arrival_date_time,
          scheduled_arrival_date_time_local
        } );

      int web3_transaction_check_delay_in_ms = 1000;

      TransactionReceipt receipt = null;
      while (receipt == null)
      {
        await Task.Delay(web3_transaction_check_delay_in_ms);
        receipt = await web3geth.Eth.Transactions.GetTransactionReceipt.SendRequestAsync(tx_hash);
      }

      //bool_result = await web3geth.Miner.Stop.SendRequestAsync();

      return JsonConvert.SerializeObject(receipt);
    }

    public async Task SetStatus(string task_uuid, string input)
    {
      Web3Geth web3geth = _web3geth;
      string sender_address = _default_sender_address;
      string contract_address = _test_existing_contract_address;
      string contract_abi = _contract_abi;
      string contract_bytecode = _contract_bytecode;      

      // connection problem? Windows firewall TCP 8545
      // TODO 測試 deploy to local blockchain => test local set function and event

      Contract contract = web3geth.Eth.GetContract(contract_abi, contract_address);

      string task_uuid_sha3 = $"0x{_web3geth.Sha3(task_uuid)}";
      //Bytes32TypeEncoder encoder = new Bytes32TypeEncoder();
      //byte[] task_uuid_sha3_bytes32 = encoder.Encode(task_uuid_sha3);
      byte[] task_uuid_sha3_bytes32 = task_uuid_sha3.HexToByteArray();

      var set_status_event = contract.GetEvent("event_set_status");
      var set_status_event_filter = await set_status_event.CreateFilterAsync(task_uuid_sha3_bytes32);

      Function set_status_function = contract.GetFunction("set_status");

      var wei = new HexBigInteger(0);
      var tx_hash = await set_status_function.SendTransactionAsync(from: sender_address, gas: new HexBigInteger(4700000), value: wei, functionInput: new object[] { task_uuid, input });

      //bool bool_result = await web3geth.Miner.Start.SendRequestAsync(120);

      int web3_transaction_check_delay_in_ms = 1000;

      TransactionReceipt receipt = null;
      while (receipt == null)
      {
        await Task.Delay(web3_transaction_check_delay_in_ms);
        receipt = await web3geth.Eth.Transactions.GetTransactionReceipt.SendRequestAsync(tx_hash);
      }

      //bool_result = await web3geth.Miner.Stop.SendRequestAsync();

      //var set_status_event_logs = await set_status_event.GetFilterChanges<EventSetStatus>(set_status_event_filter);

      //bool uninstall_successful = await _web3geth.Eth.Filters.UninstallFilter.SendRequestAsync(set_status_event_filter);
    }

    public class EventNewFlight
    {
      [Parameter("bytes32", "task_uuid", 1, true)]
      public byte[] task_uuid { get; set; }

      [Parameter("address", "flight_contract_address", 2, false)]
      public string flight_contract_address { get; set; }
    }

    public class EventSetStatus
    {
      [Parameter("bytes32", "task_uuid", 1, true)]
      public byte[] task_uuid { get; set; }

      [Parameter("string", "old_val", 2, false)]
      public string old_val { get; set; }

      [Parameter("string", "new_val", 3, false)]
      public string new_val { get; set; }
    }
  }
}
